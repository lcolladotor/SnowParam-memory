---
output:
  knitrBootstrap::bootstrap_document:
    theme.chooser: FALSE
    highlight.chooser: FALSE
  html_document:
    toc: true
    theme: spacelab
---

Memory issues with BiocParallel
=====

This repo is about a memory issue with `BiocParallel` in the computing cluster I have access to managed by a SGE system. The full post can be found at the [Bioc-devel](https://stat.ethz.ch/pipermail/bioc-devel/2015-July/007788.html) mailing list. Basically, it seems that after R changed to version 3.2 -- which matches other major changes to `BiocParallel` -- the memory used greatly increased when using `SnowParam()`. 

I first noticed this issue when attempting to reproduce the results of [step1-fullCoverage.sh](https://github.com/leekgroup/derSoftware/blob/gh-pages/step1-fullCoverage.sh) using R 3.2.x (using `sh step1-fullCoverage.sh brainspan`). Previously with R 3.1.x, the script used 173.5 GB of RAM and in R 3.2 and 3.2.x it reached 450 GB before getting shut down by the cluster system. The main package used in that script is basically identical between R versions 3.1.x and 3.2, and while `SnowParam()` did change it's also likely that the issue is related to another package(s). Note that the results and memory used are reproducible with R 3.1.x.

Here I made some scripts to try to show the problem with a smaller data set. The actual scripts are [SnowParam-memory.R](https://github.com/lcolladotor/SnowParam-memory/tree/gh-pages/SnowParam-memory.R) and [SnowParam-memory.sh](https://github.com/lcolladotor/SnowParam-memory/tree/gh-pages/SnowParam-memory.sh) which are run using `sh SnowParam-memory.sh`. It runs the same code for R versions 3.1.x, 3.2 and 3.2.x. 


## Data

Below is the summary information for these jobs with memory shown in GB used, as reported by the cluster I'm using. The actual files are at [mem_emails](https://github.com/lcolladotor/SnowParam-memory/tree/gh-pages/mem_emails). The log files are avaiable at [logs](https://github.com/lcolladotor/SnowParam-memory/tree/gh-pages/logs).

```{r 'summary', bootstrap.show.code = FALSE}
df <- data.frame(
    memory = c(6.404, 5.170, 5.036, 12.926, 12.899, 11.735, NA, NA, NA),
    R = rep(c('3.2.x', '3.2', '3.1.x'), 3),
    param = rep(c('snow', 'multicore', 'serial'), each = 3)
)
knitr::kable(df, format = 'html')
```

The same information is shown below in a plot.

```{r 'plot', bootstrap.show.code = FALSE}
library('ggplot2')
ggplot(df, aes(x = memory, y = R, colour = param)) + geom_point()
```

Note that starting in R 3.2, the type of cluster is SOCK instead of PSOCK. I ignore if this could explain the observed difference.

## `derfinder` example

[SnowParam-memory-derfinder.R](https://github.com/lcolladotor/SnowParam-memory/tree/gh-pages/SnowParam-memory.R) and [SnowParam-memory-derfinder.sh](https://github.com/lcolladotor/SnowParam-memory/tree/gh-pages/SnowParam-memory.sh) compose a second example using objects and some of the code from the original use case. I wrote to see if it lead to the same memory fold changes I observe with my analysis script. Here are some of the results.

```{r 'summary-der', bootstrap.show.code = FALSE}
df2 <- data.frame(
    memory = c(13.091, 12.308, 7.175, 13.856, 13.268, 8.475, 1.027, 1.040, 927.723 / 1024),
    R = rep(c('3.2.x', '3.2', '3.1.x'), 3),
    param = rep(c('snow', 'multicore', 'serial'), each = 3)
)
knitr::kable(df2, format = 'html')
```

The same information is shown below in a plot.

```{r 'plot-der', bootstrap.show.code = FALSE}
ggplot(df2, aes(x = memory, y = R, colour = param)) + geom_point()
```

In this example, the memory fold change when using `SnowParam()` between R 3.2.x and 3.1.x is `r signif(df2$memory[1] / df2$memory[3], 3)`x, compared to `r signif(df$memory[1] / df$memory[3], 3)`x from the first example. In comparison, with `SerialParam()` the same fold changes are `r signif(df2$memory[7] / df2$memory[9], 3)`x and `r signif(df$memory[7] / df$memory[9], 3)`x respectively.

As shown in the [compare view](https://github.com/lcolladotor/derfinder/compare/bioc3.0...master) nothing changed in [filterData()](https://github.com/lcolladotor/derfinder/blob/master/R/filterData.R) between R 3.1.x and 3.2.x.


This page was last updated at `r Sys.time()`.

